input:
  documents:
    type: document
  workspace:
    type: workspace
  standard-document-tag:
    type: text
    value: "Master"

actions:
  # 1) Tag Collections for Different Categories
  get-document-tags:
    tool: find-tags
    category: ["Master", "Amendment"]

  get-standard-tags:
    tool: find-tags
    category: "Master"

  get-amendment-tags:
    tool: find-tags
    category: "Amendment"

  get-security-tags:
    tool: find-tags
    name: ["Security"]

  get-payment-tags:
    tool: find-tags
    name: ["Payment Terms", "Price Increase"]

  get-term-tags:
    tool: find-tags
    name: ["Term", "Insurance Term", "Subscription Term", "Renewal"]

  # 2) Base configuration for shared prompt elements
  basePrompt:
    tool: echo
    message: |
      # Role and Context Setup
      You are a contract analysis expert focused on comparing amendments against a master agreement. Your objectives include:

      1. Comparing each amendment against the master agreement
      2. Identifying key differences between amendments
      3. Highlighting variations that may require attention or alignment
      4. Creating actionable comparisons that show changes in requirements
      5. Focusing on material changes and modifications

      When analyzing documents:
      - Focus on explicit terms and modifications
      - Identify changes to requirements
      - Note any unusual or non-standard provisions
      - Flag potential conflicts between amendments
      - Look for patterns across amendments

  # 3) Analysis prompt
  amendmentAnalysisPrompt:
    tool: echo
    message: |
      {{basePrompt}}

      Below is relevant text from the document. Please:
      - Analyze the specific provisions and modifications
      - Identify key changes and requirements
      - Note any regulatory compliance considerations
      - Highlight important terms or conditions
      - Summarize the findings concisely

      Relevant text:

  # 4) Section Title
  analysisTitle:
    tool: echo
    message: Amendment Comparison Analysis

  # 5) Initialize Knowledge Set
  init-kset:
    input:
      documents: task/documents
      documentTags: get-document-tags
      standardTags: get-standard-tags
      amendmentTags: get-amendment-tags
      securityTags: get-security-tags
      paymentTags: get-payment-tags
      termTags: get-term-tags
    tool: knowledge-set
    knowledgeSetName: "Amendment Comparison Analysis"
    operations:
      - op: set-nodes
        nodes: documents
      - op: add-dimension
        key: security
        name: "Security Requirements"
        nodes: securityTags
        priority: 1
        skipIfEmpty: true
      - op: add-dimension
        key: payment
        name: "Payment Terms"
        nodes: paymentTags
        priority: 2
        skipIfEmpty: true
      - op: add-dimension
        key: term
        name: "Term Requirements"
        nodes: termTags
        priority: 3
        skipIfEmpty: true

  # 6) Tag documents based on type
  tag-documents:
    tool: find-tags
    category: ["Master", "Amendment"]
    createIfNotFound: true

  # 7) Analyze content for each category
  analyze-security:
    repeat:
      function: analyze-category-for-document
      for: [tag]
      skipIfEmpty: tag
    input:
      tag: get-security-tags
      documents: task/documents
      basePrompt: basePrompt
      prompt: amendmentAnalysisPrompt
      title: analysisTitle
      knowledge: init-kset

  analyze-payment:
    repeat:
      function: analyze-category-for-document
      for: [tag]
      skipIfEmpty: tag
    input:
      tag: get-payment-tags
      documents: task/documents
      basePrompt: basePrompt
      prompt: amendmentAnalysisPrompt
      title: analysisTitle
      knowledge: init-kset

  analyze-term:
    repeat:
      function: analyze-category-for-document
      for: [tag]
      skipIfEmpty: tag
    input:
      tag: get-term-tags
      documents: task/documents
      basePrompt: basePrompt
      prompt: amendmentAnalysisPrompt
      title: analysisTitle
      knowledge: init-kset

  # 8) Add Results to Workspace
  add-to-workspace:
    input:
      workspace: task/workspace
      securityAnalysis: analyze-security
      paymentAnalysis: analyze-payment
      termAnalysis: analyze-term
      knowledgeForDocuments: init-kset
    tool: workspace
    operations:
      - op: add-items
        items: knowledgeForDocuments
      - op: add-items
        items: securityAnalysis
      - op: add-items
        items: paymentAnalysis
      - op: add-items
        items: termAnalysis

functions:
  analyze-category-for-document:
    input:
      tag:
        type: tag
      documents:
        type: document
      basePrompt:
        type: text
      prompt:
        type: text
      title:
        type: text
      knowledge:
        type: knowledge-set
    actions:
      get-snippets:
        input:
          documents: function/documents
          tag: function/tag
        tool: document-text
        textFilter:
          operator: "and"
          tags: [tag]

      run-prompt:
        input:
          snippets: get-snippets
          basePrompt: function/basePrompt
          prompt: function/prompt
        tool: llm
        skipIfEmpty: snippets
        prompt: |
          {{basePrompt}}
          
          Analyze the following content:
          {% for s in snippets %}
          {{s.text}}
          {% endfor %}

      create-insight:
        input:
          summary: run-prompt
          snippets: get-snippets
          tag: function/tag
          title: function/title
        skipIfEmpty: summary
        tool: insight
        text: |
          {{summary.text}}
        name: "{{title.text}} for {{tag.name}}"
        tags: [tag]
        attributes:
          category: amendment-analysis-insight
        relations:
          derived-from: [snippets]

      add-insight:
        input:
          knowledge: function/knowledge
          insight: create-insight
          snippets: get-snippets
        tool: knowledge-set
        operations:
          - op: set-nodes
            nodes: insight
          - op: set-nodes
            nodes: snippets
