input:
  documents:
    type: document
  workspace:
    type: workspace

actions:
  # Get document type tags
  get-master-tag:
    tool: find-tags
    name: "Master"
    createIfNotFound: true

  get-amendment-tag:
    tool: find-tags
    name: "Amendment"
    createIfNotFound: true

  # Get analysis category tags
  get-category-tags:
    tool: find-tags
    name: ["Security", "Payment Terms", "Price Increase", "Term", "Insurance Term", "Subscription Term", "Renewal"]
    createIfNotFound: true

  # Base prompt for comparison
  basePrompt:
    tool: echo
    message: |
      # Contract Analysis Expert
      You are analyzing changes between a master agreement and its amendments. Focus on:
      1. Identifying specific modifications
      2. Highlighting material changes
      3. Noting implications of changes
      4. Tracking cumulative impact

  # Analysis prompt
  comparisonPrompt:
    tool: echo
    message: |
      {{basePrompt}}
      Compare the master agreement against this amendment for {{category.name}}:
      1. Original Terms (Master Agreement):
      {{masterText}}
      2. Amendment Changes:
      {{amendmentText}}
      Please analyze:
      - What specific changes were made?
      - How do these changes impact the agreement?
      - Are there any material modifications to rights or obligations?
      - How does this affect the overall relationship?

  # Initialize Knowledge Set
  init-kset:
    input:
      documents: task/documents
      masterTag: get-master-tag
      amendmentTag: get-amendment-tag
      categoryTags: get-category-tags
    tool: knowledge-set
    knowledgeSetName: "Amendment Analysis"
    operations:
      - op: set-nodes
        nodes: documents
      - op: add-dimension
        key: document-type
        name: "Document Type"
        nodes: masterTag
        priority: 0
      - op: add-dimension
        key: amendment-type
        name: "Amendment Type"
        nodes: amendmentTag
        priority: 1
      - op: add-dimension
        key: categories
        name: "Analysis Categories"
        nodes: categoryTags
        priority: 2

  # Compare master against amendments
  analyze-amendments:
    input:
      documents: task/documents
      masterTag: get-master-tag
      amendmentTag: get-amendment-tag
      categoryTags: get-category-tags
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: comparisonPrompt
    repeat:
      function: analyze-amendment
      for: documents
      filter:
        tags: [get-amendment-tag]
      as: current_amendment
      input:
        masterTag: masterTag
        amendmentTag: amendmentTag
        categoryTags: categoryTags
        knowledge: knowledge
        basePrompt: basePrompt
        prompt: prompt

  # Add results to workspace
  add-to-workspace:
    input:
      workspace: task/workspace
      knowledge: analyze-amendments
    tool: workspace
    operations:
      - op: add-items
        items: knowledge

functions:
  analyze-amendment:
    input:
      documents:
        type: document
      current_amendment:
        type: document
      masterTag:
        type: tag
      amendmentTag:
        type: tag
      categoryTags:
        type: tag
      knowledge:
        type: knowledge-set
      basePrompt:
        type: text
      prompt:
        type: text
    actions:
      log-amendment-input:
        tool: echo
        message: "Current amendment input received: {{function/current_amendment}}"

      get-master-text:
        input:
          documents: function/documents
          masterTag: function/masterTag
        tool: document-text
        textFilter:
          operator: "and"
          tags: [masterTag]

      get-amendment-text:
        input:
          document: function/current_amendment
        tool: document-text

      analyze-categories:
        input:
          masterText: get-master-text
          amendmentText: get-amendment-text
          categoryTags: function/categoryTags
          knowledge: function/knowledge
          basePrompt: function/basePrompt
          prompt: function/prompt
        repeat:
          function: analyze-single-category
          for: function/categoryTags
          as: category
          input:
            masterText: masterText
            amendmentText: amendmentText
            category: category
            knowledge: knowledge
            basePrompt: basePrompt
            prompt: prompt

  analyze-single-category:
    input:
      masterText:
        type: text
      amendmentText:
        type: text
      category:
        type: tag
      knowledge:
        type: knowledge-set
      basePrompt:
        type: text
      prompt:
        type: text
    actions:
      analyze-changes:
        input:
          masterText: function/masterText
          amendmentText: function/amendmentText
          category: function/category
          basePrompt: function/basePrompt
          prompt: function/prompt
        tool: llm
        skipIfEmpty: [masterText, amendmentText]
        prompt: |
          {{prompt}}

      create-insight:
        input:
          analysis: analyze-changes
          masterText: function/masterText
          amendmentText: function/amendmentText
          category: function/category
        skipIfEmpty: analysis
        tool: insight
        text: |
          {{analysis.text}}
        name: "Changes to {{category.name}}"
        tags: [category]
        attributes:
          category: amendment-comparison
          analysisType: category.name
        relations:
          derived-from: [masterText, amendmentText]

      add-insight:
        input:
          knowledge: function/knowledge
          insight: create-insight
        tool: knowledge-set
        operations:
          - op: set-nodes
            nodes: insight