input:
    documents:
        type: document
    currentPeriodTag: 
        type: tag
        multiple: false
        label: Current Period Tag
    previousPeriodTag:
        type: tag
        multiple: false
        label: Previous Period Tag
    workspace:
        type: workspace

actions:
    get-period-tags:
        tool: find-tags
        category: ["Time Period"]

    get-theme-tags:
        tool: find-tags
        category: ["Theme"]

    init-kset:
        input:
            periodTags: get-period-tags
            themeTags: get-theme-tags
            documents: task/documents
        tool: knowledge-set
        knowledgeSetName: "Consistency Checker"
        operations:
            -   op: add-dimension
                key: theme
                name: Theme
                priority: 1
                nodes: themeTags
            -   op: add-dimension
                key: period
                name: Period
                priority: 2
                nodes: periodTags
            -   op: set-nodes
                nodes: documents   

    summarize-theme-current-period:
        repeat:
            function: summarize-theme-for-period
            for: [periodTag, themeTag]
        input:
            themeTag: get-theme-tags
            documents: task/documents
            kset: init-kset
            periodTag: task/currentPeriodTag

    summarize-theme-previous-period:
        repeat:
            function: summarize-theme-for-period
            for: [periodTag, themeTag]
        input:
            themeTag: get-theme-tags
            documents: task/documents
            kset: init-kset
            periodTag: task/previousPeriodTag

    compare-periods-for-themes:
        repeat:
            function: compare-periods-for-theme
            for: [curPeriodTag, prevPeriodTag, themeTag]
        input:
            themeTag: get-theme-tags
            curPeriodTag: task/currentPeriodTag
            prevPeriodTag: task/previousPeriodTag
            kset: init-kset
            summarize-theme-current-period: summarize-theme-current-period # dependency
            summarize-theme-previous-period: summarize-theme-previous-period # dependency

    add-to-workspace:
        input:
            workspace: task/workspace
            summarize-theme-current-period: summarize-theme-current-period # dependency
            summarize-theme-previous-period: summarize-theme-previous-period #dependency
            compare-periods-for-themes: compare-periods-for-themes # dependency
            kset: init-kset
        tool: workspace
        operations:
            -   op: add-items
                items: kset

functions:
    summarize-theme-for-period:
        input: 
            periodTag:
                type: tag
            themeTag:
                type: tag
            kset: 
                type: knowledge-set
            documents: 
                type: document

        actions:
            get-snippets:
                input:
                    documents: function/documents
                    periodTag: function/periodTag
                    themeTag: function/themeTag
                tool: document-text
                textFilter:
                    operator: "and"
                    tags: [periodTag, themeTag]

            summary:
                input:
                    snippets: get-snippets
                    themeTag: function/themeTag
                skipIfEmpty: snippets
                tool: llm
                prompt: |
                    Below are excerpts from earnings call transcripts. Please craft a concise summary focusing on the topic of {{themeTag.name}}. 
                    Restrict your response to no more than 100 words. Emphasize your most important points by making them **bold**.

                    {% for s in snippets %}{{s.text}}
                    {% endfor %}

            create-summary-insight:
                input:
                    snippets: get-snippets
                    summary: summary
                    themeTag: function/themeTag
                    periodTag: function/periodTag
                skipIfEmpty: summary
                tool: insight
                text: "{{summary.text}}"
                tags: [periodTag, themeTag]
                name: "Summary of {{themeTag.name}} for period {{periodTag.name}}"
                attributes:
                    category: theme-by-period
                relations:
                    derived-from: [snippets]

            add-insight:
                input:
                    knowledge: function/kset
                    summaryInsight: create-summary-insight
                    snippets: get-snippets
                tool: knowledge-set
                operations:
                    - op: set-nodes
                      nodes: summaryInsight
                    - op: set-nodes
                      nodes: snippets

    compare-periods-for-theme:
        input:  
            themeTag:
                type: tag
            prevPeriodTag:
                type: tag
            curPeriodTag:
                type: tag
            kset: 
                type: knowledge-set

        actions:
            get-prev-insights:
                input:
                    knowledge: function/kset
                    themeTag: function/themeTag
                    prevPeriodTag: function/prevPeriodTag
                tool: knowledge-set-query
                nodes:
                    type: insight
                    attributes:
                        category: theme-by-period
                nodeDimensions:
                    exactMatch: false
                    match:
                      - key: theme
                        values: themeTag 
                      - key: period
                        values: prevPeriodTag 

            get-cur-insights:
                input:
                    knowledge: function/kset
                    themeTag: function/themeTag
                    curPeriodTag: function/curPeriodTag
                tool: knowledge-set-query
                nodes:
                    type: insight
                    attributes:
                        category: theme-by-period
                nodeDimensions:
                    exactMatch: false
                    match:
                      - key: theme
                        values: themeTag 
                      - key: period
                        values: curPeriodTag 

            summary:
                input:
                    prevInsights: get-prev-insights
                    curInsights: get-cur-insights
                    themeTag: function/themeTag
                    prevPeriodTag: function:prevPeriodTag
                    curPeriodTag: function:curPeriodTag
                skipIfEmpty: [prevInsights, curInsights]
                tool: llm
                prompt: |
                    Below are two summarized statements from earnings call transcripts focusing on {{themeTag.name}} in two different periods.
                    The first covers {{prevPeriodTag.name}}, and the second covers {{curPeriodTag.name}}.
                    Please write an in-depth comparison of how each period addresses {{themeTag.name}}. 
                    In particular, highlight any **inconsistencies** in bold, especially those related to forward-looking or predictive statements 
                    that contradict or differ between {{prevPeriodTag.name}} and {{curPeriodTag.name}}.

                    Summary from {{prevPeriodTag.name}}: 
                    {% for x in prevInsights %}{{x.text}}{% endfor %}

                    Summary from {{curPeriodTag.name}}:
                    {% for x in curInsights %}{{x.text}}{% endfor %}

            create-summary-insight:
                input:
                    summary: summary
                    prevInsights: get-prev-insights
                    curInsights: get-cur-insights
                    themeTag: function:themeTag
                    prevPeriodTag: function:prevPeriodTag
                    curPeriodTag: function:curPeriodTag
                skipIfEmpty: summary
                tool: insight
                text: "{{summary.text}}"
                tags: [themeTag]
                name: "Consistency analysis for {{themeTag.name}} ({{curPeriodTag.name}} vs. {{prevPeriodTag.name}})"
                attributes:
                    category: consistency-by-theme
                relations:
                    derived-from: [prevInsights, curInsights]

            add-insight:
                input:
                    knowledge: function:kset
                    summary-insight: create-summary-insight
                tool: knowledge-set
                operations:
                    - op: set-nodes
                      nodes: summary-insight