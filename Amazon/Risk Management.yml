input:
  documents:
    type: document
  workspace:
    type: workspace

actions:
  # 1) Tag Collections for Risk Management Categories
  get-risk-management-tags:
    tool: find-tags
    name:
      - "General Liability"
      - "Excess Liability"
      - "Workers Compensation"
      - "Auto Liability"
      - "Loss of Use"
      - "Policy Endorsements"
      - "Cancellation"
      - "Indemnity"

  # 2) Base configuration for shared prompt elements
  basePrompt:
    tool: echo
    message: |
      # Role and Context Setup
      You are an insurance compliance expert analyzing contract documents. Your objectives include:

      1. Verifying correct insurance terminology and coverage requirements
      2. Validating coverage limits and policy structures
      3. Ensuring compliance with statutory requirements
      4. Reviewing endorsements and exclusions
      5. Analyzing indemnification provisions

      When analyzing the content:
      - Focus on specific insurance requirements
      - Identify terminology breaches
      - Verify coverage limits
      - Flag non-standard provisions
      - Note required modifications

  # 3) Analysis prompt
  insuranceAnalysisPrompt:
    tool: echo
    message: |
      {{basePrompt}}

      Below is relevant text from the insurance document. Please:
      - Analyze the specific provisions related to the tagged category
      - Identify key requirements and coverage limits
      - Note any compliance violations
      - Highlight important terms or conditions
      - Summarize the findings concisely

      Relevant text from the document:

  # 4) Section Title
  insuranceAnalysisTitle:
    tool: echo
    message: Insurance Requirements Analysis

  # 5) Initialize Knowledge Set
  init-kset:
    input:
      documents: task/documents
      riskManagementTags: get-risk-management-tags
    tool: knowledge-set
    knowledgeSetName: "Insurance Requirements Analysis"
    operations:
      - op: set-nodes
        nodes: documents
      - op: add-dimension
        key: risk_management
        name: "Risk Management"
        nodes: riskManagementTags
        skipIfEmpty: true
        priority: 1

  # 6) Analyze each insurance category
  analyze-insurance-categories:
    repeat:
      function: analyze-for-tag
      for: [tag]
    input:
      tag: get-risk-management-tags
      documents: task/documents
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: insuranceAnalysisTitle

  # 7) Add Results to Workspace
  add-to-workspace:
    input:
      workspace: task/workspace
      insuranceAnalysis: analyze-insurance-categories
      knowledgeForDocuments: init-kset
    tool: workspace
    operations:
      - op: add-items
        items: "insuranceAnalysis,knowledgeForDocuments"

functions:
  analyze-for-tag:
    input:
      tag:
        type: tag
      documents:
        type: document
      knowledge:
        type: knowledge-set
      basePrompt:
        type: text
      prompt:
        type: text
      title:
        type: text

    actions:
      get-snippets:
        input:
          tag: function/tag
          documents: function/documents
        tool: document-text
        textFilter:
          tags: [tag]
        skipIfEmpty: documents

      analyze-content:
        input:
          snippets: get-snippets
          basePrompt: function/basePrompt
          prompt: function/prompt
        tool: llm
        skipIfEmpty: snippets
        prompt: |
          INSURANCE REQUIREMENTS ANALYSIS:

          {% if tag.category == "General Liability" %}
          GENERAL LIABILITY ANALYSIS REQUIREMENTS:

          You must output in this exact format with all sections:

          **Coverage Overview:**
          [Single paragraph summarizing liability coverage framework and terminology requirements. Include key compliance points.]

          **Key Requirements:**
          - Replace "Comprehensive General Liability" or "Public Liability" with "Commercial General Liability"
          - Verify coverage limits and umbrella policy references
          - Default to "blanket endorsement" unless specific broker requirement exists
          - Ensure renewal certificate timing and cancellation notice provisions

          **Compliance Checklist:**
          - List all terminology that needs updating
          - Detail coverage limits and verification methods
          - Document endorsement requirements
          - Note certificate and notice provisions
          {% endif %}

          {% if tag.category == "Excess Liability" %}
          EXCESS LIABILITY ANALYSIS REQUIREMENTS:

          You must output in this exact format with all sections:

          **Coverage Overview:**
          [Single paragraph summarizing excess liability framework and coverage structure. Include key limits and umbrella requirements.]

          **Key Requirements:**
          - Verify coverage limits ($1M per occurrence, $2M aggregate)
          - Check umbrella policy references
          - Review combined primary and excess coverage structure

          **Compliance Checklist:**
          - List all coverage limits and thresholds
          - Detail umbrella policy specifications
          - Document coverage combination requirements
          {% endif %}

          {% if tag.category == "Workers Compensation" %}
          WORKERS COMPENSATION ANALYSIS REQUIREMENTS:

          You must output in this exact format with all sections:

          **Coverage Overview:**
          [Single paragraph summarizing workers compensation requirements and employer's liability limits. Include key compliance points.]

          **Key Requirements:**
          - Confirm statutory limits from payroll service
          - Verify Employer's Liability maximum of $1M
          - Flag unauthorized third-party insured additions
          - Review subrogation clauses against payroll service standards

          **Compliance Checklist:**
          - List statutory requirements and limits
          - Detail employer's liability specifications
          - Document third-party and subrogation restrictions
          {% endif %}

          {% if tag.category == "Auto Liability" %}
          AUTO LIABILITY ANALYSIS REQUIREMENTS:

          You must output in this exact format with all sections:

          **Coverage Overview:**
          [Single paragraph summarizing auto liability requirements and coverage specifications. Include key compliance points.]

          **Key Requirements:**
          - Remove "owned" or "any auto" references unless specifically endorsed
          - Specify pollution coverage as "if caused by Accident"
          - Review and correct hired/non-owned vehicle coverage terms

          **Compliance Checklist:**
          - List vehicle coverage specifications
          - Detail pollution coverage requirements
          - Document endorsement conditions
          {% endif %}

          {% if tag.category == "Loss of Use" %}
          LOSS OF USE ANALYSIS REQUIREMENTS:

          You must output in this exact format with all sections:

          **Coverage Overview:**
          [Single paragraph summarizing loss of use requirements and payment terms. Include key compliance points.]

          **Key Requirements:**
          - Include "actual and verifiable" language
          - Remove payment until replacement provisions
          - Validate repair coverage and payout terms

          **Compliance Checklist:**
          - List required terminology
          - Detail payment restrictions
          - Document coverage specifications
          {% endif %}

          {% if tag.category == "Indemnity" %}
          INDEMNITY ANALYSIS REQUIREMENTS:

          You must output in this exact format with all sections:

          **Coverage Overview:**
          [Single paragraph summarizing indemnity requirements and documentation standards. Include key compliance points.]

          **Key Requirements:**
          - Add "reasonable outside" before attorney's fees
          - Include wear and tear exceptions
          - Remove loss of profits references
          - Strike policy copy requirements
          - Confirm certificate provision instead of policy copies

          **Compliance Checklist:**
          - List terminology requirements
          - Detail documentation standards
          - Document prohibited terms
          {% endif %}

          Analyze the provided content according to these requirements. Focus on:
          1. Identifying non-compliant language
          2. Flagging missing required elements
          3. Suggesting specific corrections
          4. Noting any unusual provisions
          
          {{prompt.text}}
          {% for s in snippets %}
          {{s.text}}
          {% endfor %}

      create-insight:
        input:
          summary: analyze-content
          snippets: get-snippets
          tag: function/tag
          title: function/title
        skipIfEmpty: summary
        tool: insight
        text: |
          {{summary.text}}
        name: "{{title.text}} for {{tag.name}}"
        tags: [tag]
        attributes:
          category: insurance-analysis-insight
        relations:
          derived-from: [snippets]

      add-insight:
        input:
          knowledge: function/knowledge
          insight: create-insight
          snippets: get-snippets
        tool: knowledge-set
        operations:
          - op: set-nodes
            nodes: "insight"
          - op: set-nodes
            nodes: "snippets"