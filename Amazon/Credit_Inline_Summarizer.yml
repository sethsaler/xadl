input:
  documents:
    type: document
  # Removed workspace and knowledgeset inputs

actions:
  # 1) Existing Tag Collection for Agreement Information
  get-butterfly-tags:
    tool: find-tags
    name: "Butterfly"
  
  get-credit-tags:
    tool: find-tags
    name: "Credit"
  
  # 2) REMOVED Tag Collection for "Document Tags"
  # get-documentCategory-tags:
  #   tool: find-tags
  #   category: "Document Tags"

  # 3) Extract relevant snippets based on Agreement Information tags
  get-butterfly-snippets:
    input:
      documents: task/documents
      tags: get-butterfly-tags
    tool: document-text
    textFilter:
      tags: tags
  
  get-credit-snippets:
    input:
      documents: task/documents
      tags: get-credit-tags
    tool: document-text
    textFilter:
      tags: tags

  # 4) Generate the consolidated summary using LLM
  generate-summary:
    input:
      butterflySnippets: get-butterfly-snippets
      creditSnippets: get-credit-snippets
    tool: llm
    skipIfEmpty: butterflySnippets # Use SkipIfEmpty as requested
    prompt: |
      You are in-house counsel at a major entertainment studio tasked with identifying credit obligations owed on a film or television series. Your objective is to locate and consolidate all obligations, commitments, and representations the studio has made regarding screen credits for talent or other parties, including but not limited to: performers, writers, producers, executive producers, and directors.

      When providing findings:
      - Do NOT paraphrase any credit language. Extract and present the relevant contract or document language verbatim, combining it into a single paragraph.
      - Do not reformat into a bullet list.
      - Focus on clarity, precision, and strict relevance to studio obligations.
      - Avoid speculation; limit your analysis to explicit terms and established industry standards.

      # Analysis Task
      You will receive text snippets extracted from talent agreement(s) relating to agreement metadata information and credit obligations. Your task is to consolidate this information into a structured summary document.

      # DEBUG INFORMATION
      Butterfly snippets: {{butterflySnippets.size}}
      Credit snippets: {{creditSnippets.size}}

      {% assign agreements = "" | split: "" %}
      {% assign credits = "" | split: "" %}
      
      # Process Butterfly snippets for agreement info
      {% for snippet in butterflySnippets %}
        {% capture agreementInfo %}
        ### Agreement Information
        Extract and format the following information if found in the text, using this exact format:
        **Talent Name:** [Name]
        **Talent Type:** [Category]
        **Role:** [Character Name]
        **Agreement Name:** [Title]
        **Effective Date:** [Date]
        **Project Name:** [Title]
        **Episode(s):** [Episode number(s)] (if none, put "Not Specified")

        Required Field Definitions:

        **Talent Name:** Name of individual or team.
        **Talent Type:** Role category (e.g., Writer, Director, Producer, Performer, Physical Producer, Lead Cast).
        **Role:** Character/role name (N/A if not applicable).
        **Agreement Name:** Title of the formal agreement.
        **Effective Date:** Defined effective date or latest signature date (if missing, use execution date and note accordingly).
        **Project Name:** Project title or working title.
        **Episode(s):** Specify if applicable; otherwise, "Not Specified."

        Relevant Text:
        {{snippet.text}}
        {% endcapture %}
        {% assign agreements = agreements | push: agreementInfo %}
      {% endfor %}
      
      # Process Credit snippets
      {% for snippet in creditSnippets %}
        {% capture creditInfo %}
        ### Credit Obligations
        Combine into a single paragraph only the contract language directly related to credit and billing. Maintain original wording â€” do not paraphrase. Focus on:
        - Main titles vs. end titles
        - Special designations (e.g., "guest star," "special appearance")
        - Single card vs. shared card, including card position (first, second, etc.)
        - Type size, prominence, or other format requirements
        - "No less favorable than..." or parity obligations
        - Any studio or producer discretion rights
        - Specific episode credits (if applicable or varied)
        
        Important:
        - Include only credit-related obligations specific to providing credit on a series or film.
        - Exclude information about compensation, bonuses, exclusivity, use of image or likeness, or any unrelated terms.
        - Exclude credit boilerplate terms, including:  remedies for failure to provide credit or for incorrect credit; errors and ommissions relating to credit; efforts to correct errors; or what happens in the event of breach of contract.
        - Strictly adhere to the format above without adding extra commentary.
        - If the provided text does not contain any credit obligations, output "No credit obligations specified."

        Relevant Text:
        {{snippet.text}}
        {% endcapture %}
        {% assign credits = credits | push: creditInfo %}
      {% endfor %}

      # Final Stats
      Found {{agreements.size}} agreement(s) and {{credits.size}} credit(s)

      # Combine all structured outputs
      {% if agreements.size > 0 %}
      ## Document Information and Credit Obligations

      {% for agreement in agreements %}
      {{agreement}}
      {% endfor %}

      {% if credits.size > 0 %}
      {% for credit in credits %}
      {{credit}}
      {% endfor %}
      {% else %}
      ### Credit Obligations
      No credit obligations specified.
      {% endif %}
      
      {% else %}
      No relevant information found in the provided text. Please ensure the document contains sections tagged with "Butterfly" for proper analysis.
      {% endif %}