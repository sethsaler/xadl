input:
  documents:
    type: document
  workspace:
    type: workspace
  knowledge:
    type: knowledge-set

actions:
  get-performance-tags:
    tool: find-tags
    name: ["Performance Trigger", "Performance Metric", "Performance Threshold"]
  
  analyze-triggers:
    repeat:
      function: analyze-performance-trigger
      for: [performanceTag]
    input:
      documents: input/documents
      performanceTag: get-performance-tags
      knowledge: init-knowledge-set

  summarize-triggers:
    input:
      analysis: analyze-triggers
      workspace: input/workspace
    tool: summarize
    prompt: |
      Create a structured summary of all performance triggers, their conditions, and associated metrics. Format the output as follows:
      
      performance_triggers:
        - name: [Trigger Name]
          condition: [Trigger Condition]
          metrics:
            - name: [Metric Name]
              threshold: [Metric Threshold]
              unit: [Metric Unit]
          associated_actions: [List of Associated Actions]
      
      Ensure each trigger is clearly defined with its specific conditions and metrics.
  
  add-to-workspace:
    input:
      workspace: input/workspace
      triggerAnalysis: analyze-triggers
      summary: summarize-triggers
    tool: workspace
    operations:
      - op: add-items
        items: triggerAnalysis
      - op: add-items
        items: summary

functions:
  analyze-performance-trigger:
    input:
      performanceTag:
        type: tag
      documents:
        type: document
      knowledge:
        type: knowledge-set
    actions:
      get-performance-snippets:
        input:
          tag: function/performanceTag
          documents: function/documents
        tool: document-text
        textFilter:
          operator: "and"
          tags: [performanceTag]
      
      analyze-performance-metrics:
        input:
          snippets: get-performance-snippets
          knowledge: function/knowledge
        tool: llm
        prompt: |
          Analyze the following snippets and extract structured information about performance triggers:
          
          {% for snippet in snippets %}
          {{ snippet.text }}
          {% endfor %}
          
          For each performance trigger, provide the following information:
          - Trigger name
          - Condition
          - Associated metrics (name, threshold, unit)
          - Any associated actions
          
          Format the output as follows:
          
          performance_triggers:
            - name: [Trigger Name]
              condition: [Trigger Condition]
              metrics:
                - name: [Metric Name]
                  threshold: [Metric Threshold]
                  unit: [Metric Unit]
              associated_actions:
                - [Action 1]
                - [Action 2]