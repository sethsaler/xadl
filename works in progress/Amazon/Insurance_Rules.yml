input:
  documents:
    type: document
  workspace:
    type: workspace

actions:
  # 1) Tag Collections for Insurance Categories
  get-general-liability-tags:
    tool: find-tags
    category: "General Liability"

  get-excess-liability-tags:
    tool: find-tags
    category: "Excess Liability"

  get-workers-comp-tags:
    tool: find-tags
    category: "Workers Compensation"

  get-auto-liability-tags:
    tool: find-tags
    category: "Auto Liability"

  get-loss-use-tags:
    tool: find-tags
    category: "Loss of Use"

  get-endorsement-tags:
    tool: find-tags
    category: "Policy Endorsements"

  get-cancellation-tags:
    tool: find-tags
    category: "Cancellation"

  get-indemnity-tags:
    tool: find-tags
    category: "Indemnity"

  # 2) Base configuration for shared prompt elements
  basePrompt:
    tool: echo
    message: |
      # Role and Context Setup
      You are an insurance compliance expert analyzing contract documents. Your objectives include:

      1. Verifying correct insurance terminology and coverage requirements
      2. Validating coverage limits and policy structures
      3. Ensuring compliance with statutory requirements
      4. Reviewing endorsements and exclusions
      5. Analyzing indemnification provisions

      When analyzing the content:
      - Focus on specific insurance requirements
      - Identify terminology breaches
      - Verify coverage limits
      - Flag non-standard provisions
      - Note required modifications

  # 3) Analysis prompt
  insuranceAnalysisPrompt:
    tool: echo
    message: |
      {{basePrompt}}

      Below is relevant text from the insurance document. Please:
      - Analyze the specific provisions related to the tagged category
      - Identify key requirements and coverage limits
      - Note any compliance violations
      - Highlight important terms or conditions
      - Summarize the findings concisely

      Relevant text from the document:

  # 4) Section Title
  analysisTitle:
    tool: echo
    message: Insurance Requirements Analysis

  # 5) Initialize Knowledge Set
  init-kset:
    input:
      documents: task/documents
      generalLiabilityTags: get-general-liability-tags
      excessLiabilityTags: get-excess-liability-tags
      workersCompTags: get-workers-comp-tags
      autoLiabilityTags: get-auto-liability-tags
      lossUseTags: get-loss-use-tags
      endorsementTags: get-endorsement-tags
      cancellationTags: get-cancellation-tags
      indemnityTags: get-indemnity-tags
    tool: knowledge-set
    knowledgeSetName: "Insurance Requirements Analysis"
    operations:
      - op: set-nodes
        nodes: documents
      - op: add-dimension
        key: general_liability
        name: "General Liability"
        nodes: generalLiabilityTags
        priority: 1
        skipIfEmpty: true
      - op: add-dimension
        key: excess_liability
        name: "Excess Liability"
        nodes: excessLiabilityTags
        priority: 2
        skipIfEmpty: true
      - op: add-dimension
        key: workers_comp
        name: "Workers Compensation"
        nodes: workersCompTags
        priority: 3
        skipIfEmpty: true
      - op: add-dimension
        key: auto_liability
        name: "Auto Liability"
        nodes: autoLiabilityTags
        priority: 4
        skipIfEmpty: true
      - op: add-dimension
        key: loss_use
        name: "Loss of Use"
        nodes: lossUseTags
        priority: 5
        skipIfEmpty: true
      - op: add-dimension
        key: endorsements
        name: "Policy Endorsements"
        nodes: endorsementTags
        priority: 6
        skipIfEmpty: true
      - op: add-dimension
        key: cancellation
        name: "Cancellation"
        nodes: cancellationTags
        priority: 7
        skipIfEmpty: true
      - op: add-dimension
        key: indemnity
        name: "Indemnity"
        nodes: indemnityTags
        priority: 8
        skipIfEmpty: true

  # 6) Category-specific analyses
  analyze-general-liability:
    repeat:
      function: analyze-for-tag
      for: [tag]
    input:
      tag: get-general-liability-tags
      documents: task/documents
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-excess-liability:
    repeat:
      function: analyze-for-tag
      for: [tag]
    input:
      tag: get-excess-liability-tags
      documents: task/documents
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-workers-comp:
    repeat:
      function: analyze-for-tag
      for: [tag]
    input:
      tag: get-workers-comp-tags
      documents: task/documents
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-auto-liability:
    repeat:
      function: analyze-for-tag
      for: [tag]
    input:
      tag: get-auto-liability-tags
      documents: task/documents
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-loss-use:
    repeat:
      function: analyze-for-tag
      for: [tag]
    input:
      tag: get-loss-use-tags
      documents: task/documents
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-endorsements:
    repeat:
      function: analyze-for-tag
      for: [tag]
    input:
      tag: get-endorsement-tags
      documents: task/documents
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-cancellation:
    repeat:
      function: analyze-for-tag
      for: [tag]
    input:
      tag: get-cancellation-tags
      documents: task/documents
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-indemnity:
    repeat:
      function: analyze-for-tag
      for: [tag]
    input:
      tag: get-indemnity-tags
      documents: task/documents
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  # 7) Document-level analyses
  analyze-documents-general:
    repeat:
      function: analyze-document-insurance
      for: [document]
    input:
      document: task/documents
      insuranceTags: get-general-liability-tags
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-documents-excess-liability:
    repeat:
      function: analyze-document-insurance
      for: [document]
    input:
      document: task/documents
      insuranceTags: get-excess-liability-tags
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-documents-workers-comp:
    repeat:
      function: analyze-document-insurance
      for: [document]
    input:
      document: task/documents
      insuranceTags: get-workers-comp-tags
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-documents-auto-liability:
    repeat:
      function: analyze-document-insurance
      for: [document]
    input:
      document: task/documents
      insuranceTags: get-auto-liability-tags
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-documents-loss-use:
    repeat:
      function: analyze-document-insurance
      for: [document]
    input:
      document: task/documents
      insuranceTags: get-loss-use-tags
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-documents-endorsements:
    repeat:
      function: analyze-document-insurance
      for: [document]
    input:
      document: task/documents
      insuranceTags: get-endorsement-tags
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-documents-cancellation:
    repeat:
      function: analyze-document-insurance
      for: [document]
    input:
      document: task/documents
      insuranceTags: get-cancellation-tags
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  analyze-documents-indemnity:
    repeat:
      function: analyze-document-insurance
      for: [document]
    input:
      document: task/documents
      insuranceTags: get-indemnity-tags
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: insuranceAnalysisPrompt
      title: analysisTitle

  # 8) Add Results to Workspace
  add-to-workspace:
    input:
      workspace: task/workspace
      knowledge: init-kset
    tool: workspace
    operations:
      - op: add-items
        items: knowledge

functions:
  analyze-for-tag:
    input:
      tag:
        type: tag
      documents:
        type: document
      knowledge:
        type: knowledge-set
      basePrompt:
        type: text
      prompt:
        type: text
      title:
        type: text
    actions:
      get-snippets:
        input:
          documents: function/documents
          tag: function/tag
        tool: document-text
        textFilter:
          operator: "and"
          tags: [tag]

      analyze-content:
        input:
          snippets: get-snippets
          basePrompt: function/basePrompt
          prompt: function/prompt
        tool: llm
        skipIfEmpty: snippets
        prompt: |
          {{prompt.text}}
          {% for s in snippets %}
          {{s.text}}
          {% endfor %}

      create-insight:
        input:
          summary: analyze-content
          snippets: get-snippets
          tag: function/tag
          title: function/title
        skipIfEmpty: summary
        tool: insight
        text: |
          {{summary.text}}
        name: "{{title.text}} for {{tag.name}}"
        tags: [tag]
        attributes:
          category: insurance-analysis-insight
        relations:
          derived-from: [snippets]

      add-insight:
        input:
          knowledge: function/knowledge
          insight: create-insight
          snippets: get-snippets
        tool: knowledge-set
        operations:
          - op: set-nodes
            nodes: insight
          - op: set-nodes
            nodes: snippets

  analyze-document-insurance:
    input:
      document:
        type: document
      insuranceTags:
        type: tag[]
      knowledge:
        type: knowledge-set
      basePrompt:
        type: text
      prompt:
        type: text
      title:
        type: text
    actions:
      get-snippets:
        input:
          documents: function/document
          insuranceTags: function/insuranceTags
        tool: document-text
        textFilter:
          operator: "and"
          tags: [insuranceTags]

      analyze-content:
        input:
          snippets: get-snippets
          basePrompt: function/basePrompt
          prompt: function/prompt
        tool: llm
        skipIfEmpty: snippets
        prompt: |
          INSURANCE REQUIREMENTS ANALYSIS:
          
          Analyze all insurance requirements for this document. Include:
          
          1. Coverage types and limits
          2. Policy endorsement requirements
          3. Compliance verification methods
          4. Notification requirements
          5. Cancellation provisions
          6. Indemnification obligations
          7. Special conditions or exclusions
          
          {{prompt.text}}
          {% for s in snippets %}
          {{s.text}}
          {% endfor %}

      create-insight:
        input:
          summary: analyze-content
          snippets: get-snippets
          document: function/document
          title: function/title
        skipIfEmpty: summary
        tool: insight
        text: |
          {{summary.text}}
        name: "{{title.text}} Insurance Analysis for {{document.name}}"
        tags: [insuranceTags]
        attributes:
          category: insurance-document-analysis
        relations:
          derived-from: [snippets]

      add-insight:
        input:
          knowledge: function/knowledge
          insight: create-insight
          snippets: get-snippets
        tool: knowledge-set
        operations:
          - op: set-nodes
            nodes: insight
          - op: set-nodes
            nodes: snippets
