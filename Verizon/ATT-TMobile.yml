input:
  documents:
    type: document
  workspace:
    type: workspace

actions:
  # 1) Tag Collections for Document Tags and Category Tags
  get-document-tags:
    tool: find-tags
    name: ["AT&T", "T-Mobile"]

  get-category-tags:
    tool: find-tags
    name: ["Term and Termination", "Customer Invoices and Payment; Disputed Amounts", 
           "Order and Repair Processes", "Rates and Charges", "Provided Facilities and Equipment", 
           "Successors and Assigns", "Indemnification", "Liability"]

  # 2) Base configuration for shared prompt elements
  basePrompt:
    tool: echo
    message: |
      # Role and Context Setup
      You are a telecommunications contract analyst specialized in comparing service agreements between major carriers. Your objectives include:

      1. Identifying key terms, conditions, and obligations in each carrier's agreements
      2. Comparing similar contract provisions across carriers to highlight important differences
      3. Spotting potential advantages, disadvantages, or unique approaches in each agreement
      4. Providing clear, actionable insights about contractual differences that could impact service quality, cost, or risk

      When analyzing these agreements:
      - Focus on substantive differences, not merely wording variations
      - Highlight material terms that could impact business operations or costs
      - Note significant variations in customer rights, carrier obligations, or liability allocations
      - Identify areas where one agreement may be more favorable than the other

  # 3) Analysis prompt for individual tag analysis
  categoryAnalysisPrompt:
    tool: echo
    message: |
      {{basePrompt}}

      Below is the text from a specific section of a telecommunications service agreement. Please:
      - Analyze the key terms, conditions, and requirements
      - Identify the carrier's obligations and customer's responsibilities
      - Note any limitations, exclusions, or special conditions
      - Highlight unusual or particularly important provisions
      - Summarize the approach taken by this carrier on this topic

      Relevant text for analysis:

  # 4) Comparison prompt for comparing tags between documents
  comparisonPrompt:
    tool: echo
    message: |
      {{basePrompt}}

      Below are sections addressing the same topic from both AT&T and T-Mobile service agreements. Please conduct a thorough comparison:

      - Identify substantive differences in approach or requirements
      - Highlight variations in carrier obligations vs customer responsibilities
      - Note differences in scope, limitations, or exclusions
      - Assess which agreement provides more favorable terms and under what circumstances
      - Summarize key differences that would impact service quality, cost, or risk exposure

      Provide your analysis as a structured comparison with clear headings.

  # 5) Section Titles
  analysisTitle:
    tool: echo
    message: Telecommunications Contract Analysis

  comparisonTitle:
    tool: echo
    message: AT&T vs T-Mobile Provision Comparison

  # 6) Initialize Knowledge Set
  init-kset:
    input:
      documents: task/documents
      documentTags: get-document-tags
      categoryTags: get-category-tags
    tool: knowledge-set
    knowledgeSetName: "AT&T vs T-Mobile Contract Comparison"
    operations:
      - op: set-nodes
        nodes: documents
      - op: add-dimension
        key: document
        name: "Carrier"
        nodes: documentTags
        priority: 1
      - op: add-dimension
        key: category
        name: "Contract Section"
        nodes: categoryTags
        priority: 2

  # 7) Analyze content for each category-document pair using required structure
  analyze-categories:
    repeat:
      function: analyze-for-tag
      for: [tag, documentTag]
    input:
      tag: get-category-tags
      documentTag: get-document-tags
      documents: task/documents
      knowledge: init-kset
      basePrompt: basePrompt
      prompt: categoryAnalysisPrompt
      title: analysisTitle

  # 8) Compare documents for each category
  compare-categories:
    repeat:
      function: compare-documents-for-category
      for: [categoryTag]
    input:
      categoryTag: get-category-tags
      knowledge: init-kset
    depends:
      - analyze-categories

  # 9) Add Results to Workspace
  add-to-workspace:
    input:
      workspace: task/workspace
      knowledge: init-kset
    depends:
      - compare-categories
    tool: workspace
    operations:
      - op: add-items
        items: knowledge
        includeAttributes:
          - category: telecom-contract-analysis
          - category: telecom-contract-comparison

functions:
  analyze-for-tag:
    input:
      tag:
        type: tag
      documentTag:
        type: tag
      documents:
        type: document
      knowledge:
        type: knowledge-set
      basePrompt:
        type: text
      prompt:
        type: text
      title:
        type: text
    actions:
      get-snippets:
        input:
          documents: function/documents
          documentTag: function/documentTag
          tag: function/tag
        tool: document-text
        textFilter:
          operator: "and"
          tags: [documentTag, tag]

      run-analysis:
        input:
          snippets: get-snippets
          basePrompt: function/basePrompt
          prompt: function/prompt
        tool: llm
        skipIfEmpty: snippets
        prompt: |
          {{prompt.text}}
          {% for s in snippets %}
          {{s.text}}
          {% endfor %}

      create-insight:
        input:
          summary: run-analysis
          snippets: get-snippets
          tag: function/tag
          documentTag: function/documentTag
          title: function/title
        skipIfEmpty: summary
        tool: insight
        text: |
          {{summary.text}}
        name: "{{documentTag.name}}: {{tag.name}} Analysis"
        tags: [tag, documentTag]
        attributes:
          category: telecom-contract-analysis
          analysisType: single-document
        relations:
          derived-from: [snippets]

      add-insight:
        input:
          knowledge: function/knowledge
          insight: create-insight
          snippets: get-snippets
        tool: knowledge-set
        operations:
          - op: set-nodes
            nodes: insight
          - op: set-nodes
            nodes: snippets

  compare-documents-for-category:
    input:
      categoryTag:
        type: tag
      knowledge:
        type: knowledge-set
    actions:
      get-category-insights:
        input:
          knowledge: function/knowledge
          categoryTag: function/categoryTag
        tool: knowledge-set-query
        nodes:
          type: insight
          attributes:
            category: telecom-contract-analysis
            analysisType: single-document
        nodeDimensions:
          match:
            - key: category
              values: [categoryTag]

      analyze-differences:
        input:
          insights: get-category-insights
          categoryTag: function/categoryTag
        skipIfEmpty: insights
        tool: llm
        prompt: |
          # DIRECT COMPARISON: {{categoryTag.name}}
          
          Create a detailed comparison between AT&T and T-Mobile for {{categoryTag.name}} in paragraph format. Your analysis should cover the following areas:
          
          1. **Core Requirements Comparison**: Compare the fundamental obligations and requirements for both carriers related to {{categoryTag.name}}. Describe which carrier has more stringent or favorable terms and why.
          
          2. **Customer Obligations Comparison**: Analyze how customer obligations differ between the carriers. Explain which approach is more demanding or flexible for customers and the practical impact.
          
          3. **Limitations and Exclusions Comparison**: Compare any important limits, exclusions, or conditions in the provisions. Detail how these differences might affect service or rights.
          
          4. **Risk Allocation Comparison**: Describe how risk is distributed differently between the carriers for {{categoryTag.name}}. Identify which carrier assumes more or less risk and under what circumstances.
          
          5. **Financial Terms Comparison**: Compare costs, payment terms, penalties, or other financial aspects between the carriers. Note material differences in approach and impact.
          
          6. **Process Requirements Comparison**: Analyze differences in how processes, timelines, and operational requirements are handled. Discuss practical implications for implementation.
          
          7. **Overall Assessment**: Provide a summary of which carrier offers more favorable terms overall for {{categoryTag.name}} and why. Highlight the 2-3 most significant differences that would impact business operations or costs.

          ## SOURCE ANALYSIS
          
          {% assign att_insight = null %}
          {% assign tmobile_insight = null %}
          
          {% for insight in insights %}
            {% if insight.tags contains "AT&T" %}
              {% assign att_insight = insight %}
            {% endif %}
            {% if insight.tags contains "T-Mobile" %}
              {% assign tmobile_insight = insight %}
            {% endif %}
          {% endfor %}
          
          ### AT&T Analysis:
          {% if att_insight %}
          {{att_insight.text}}
          {% else %}
          No AT&T analysis available for this category.
          {% endif %}
          
          ### T-Mobile Analysis:
          {% if tmobile_insight %}
          {{tmobile_insight.text}}
          {% else %}
          No T-Mobile analysis available for this category.
          {% endif %}

      create-comparison-insight:
        input:
          summary: analyze-differences
          insights: get-category-insights
          categoryTag: function/categoryTag
        skipIfEmpty: summary
        tool: insight
        text: |
          # {{categoryTag.name}} Comparison: AT&T vs T-Mobile

          {{summary.text}}
        name: "AT&T vs T-Mobile: {{categoryTag.name}} Comparison"
        tags: [categoryTag]
        attributes:
          category: telecom-contract-comparison
          analysisType: cross-document
          comparisonType: carrier-comparison
        relations:
          derived-from: [insights]

      add-comparison:
        input:
          knowledge: function/knowledge
          insight: create-comparison-insight
        tool: knowledge-set
        operations:
          - op: set-nodes
            nodes: insight